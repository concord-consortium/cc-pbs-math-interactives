define(["acc-manager-model"],function(t){var e=Backbone.View.extend({isAccessibilityOn:null,initialize:function(e){this.isAccessibilityOn=e.isAccessibilityOn,this._isMobile()&&(this.isAccessibilityOn=!1),this.model=new t,this.model.set("isAccessibilityOn",this.isAccessibilityOn)},_isMobile:function(){var t=navigator.userAgent.toLowerCase(),e=t.indexOf("android")>-1,i=t.indexOf("chrome")>-1,n=!i&&t.indexOf("safari")>-1,s=t.indexOf("mobile")>-1&&n
return s||e},_keyPressHandler:function(t){if(this.isAccessibilityOn){var e=$(t.target),i=t?t.which:t.keyCode,n=13,s=32
"text"===e.attr("type")||"TEXTAREA"===e.prop("tagName")||i!==s&&i!==n||(t.preventDefault(),t.stopPropagation(),e.trigger("mousedown").trigger("mouseup").trigger("click"))}},setTabIndex:function(t,e){this.isAccessibilityOn&&t.attr({tabindex:e,"temp-tabindex":e}).addClass("acc-element")},getTabIndex:function(t){return t.attr("tabindex")},enableTab:function(t,e){this.isAccessibilityOn&&(e?t.attr("tabindex",t.attr("temp-tabindex")):t.attr("tabindex",-1))},enableAllTabs:function(t){if(this.isAccessibilityOn)for(var e=this.$(".acc-element"),i=0,n=e.length;n>i;i++)this.enableTab(e.eq(i),!0)},disableAllTabs:function(){if(this.isAccessibilityOn)for(var t=this.$(".acc-element"),e=0,i=t.length;i>e;e++)this.enableTab(t.eq(e),!1)},_replaceSpecialStr:function(t,e){for(var i=0;i<e.length;i++)t=t.replace("%@$%",e[i])
return t},setAccText:function(t,e,i){if(this.isAccessibilityOn){var n,s
0!==t.length&&"text"!==t.attr("type")&&(n=t.attr("aria-labelledby"),i&&(e=this._replaceSpecialStr(e,i)),n?(s=this.$("#"+n),s.html(e)):t.attr("aria-label",e))}},initializeAccessibilityComponents:function(t){if(this.isAccessibilityOn){this._setModelValues(t,!1)
var e=this._attachFirstElement(t),i=this._attachLastElement(t),n=this._attachStartWrapper(e),s=this._attachStartInputElement(n),a=this._attachEndWrapper(i),l=this._attachEndInputElement(a),r=null,c=null,d=0
for(this._attachAccessibilityEvents(t,s,l,i,e),r=t.find("[tabindex]"),c=r.length;c>d;d++)r.eq(d).attr("tabindex",-1)}},_setModelValues:function(t,e){for(var i=t.find("[tabindex]:visible:not(:disabled)"),n=[],s=[],a=i.length,l=0,r=null,c=null,d=null,o=null,h=null,u=null,b=null;a>l;l++)r=Number(i.eq(l).attr("tabindex")),n[l]=r,r>-1&&s.push(r)
0===s.length?(u=t.next().find("input"),b=t.prev().find("input")):(d=Math.min.apply(Math,s),o=$.inArray(d,n),u=i.eq(o),c=Math.max.apply(Math,n),h=$.inArray(c,n),b=i.eq(h)),this.model.set({firstElement:null,lastElement:null}),this.model.set({firstElement:u,lastElement:b,insideInteractivity:e})},_attachLastElement:function(t){var e=$("<div>",{"class":"last-focusable-element"}).insertAfter(t).css({height:0,overflow:"hidden"})
return this.model.set("lastFocusableElement",e),e},_attachFirstElement:function(t){var e=$("<div>",{"class":"first-focusable-element"}).insertBefore(t).css({height:0,overflow:"hidden"})
return this.model.set("firstFocusableElement",e),e},_attachStartWrapper:function(t){var e=$("<div>",{"class":"checkbox-wrapper start-checkbox-wrapper"}).insertBefore(t).css({height:0,overflow:"hidden"})
return e},_attachStartInputElement:function(t){var e=$("<input type='checkbox' />").attr({"class":"start-checkbox","aria-hidden":!0}).appendTo(t).css({"float":"left"})
return e},_attachEndWrapper:function(t){var e=$("<div>",{"class":"checkbox-wrapper end-checkbox-wrapper"}).insertAfter(t).css({height:0,overflow:"hidden"})
return e},_attachEndInputElement:function(t){var e=$("<input type='checkbox' />").attr({"class":"end-checkbox","aria-hidden":!0}).appendTo(t).css({"float":"left",position:"relative"})
return e},_setFocusableElementTabIndex:function(){var t=this.model.get("lastFocusableElement"),e=this.model.get("firstFocusableElement"),i=this.model.get("insideInteractivity"),n=i?this.model.get("firstTabIndex"):-1,s=i?this.model.get("tabIndexRange")+this.model.get("startTabindex"):-1
e.attr("tabindex",n),t.attr("tabindex",s)},_attachAccessibilityEvents:function(t,e,i,n,s){this._attachEventsOnStartElement(t,e),this._attachEventsOnPlayerElements(n,s)},_attachEventsOnStartElement:function(t,e){e.on("focusin.setResetTabIndex",_.bind(function(e){var i=null,n=null,s=null,a=null,l=null,r=0,c=null
if(this.model.get("insideInteractivity")){for(this._setModelValues(t,!1),i=t.find("[tabindex]"),l=i.length;l>r;r++)i.eq(r).attr("tabindex",-1)
s=$(":tabbable:visible:not(:disabled)"),n=$.inArray(this,s),this._setFocusableElementTabIndex(),_.delay(function(){s[n-1]?s[n-1].focus():s[s.length-1].focus()},100)}else{for(i=t.find("[tabindex]"),l=i.length;l>r;r++)c=i.eq(r),a=c.attr("temp-tabindex"),c.hasClass("disabled")||c.attr("tabindex",a)
this._setModelValues(t,!0),this.model.set("insideInteractivity",!0),this._setFocusableElementTabIndex(),_.delay(_.bind(function(){this.model.get("firstElement").focus()},this),100)}},this))},_attachEventsOnPlayerElements:function(t,e){t.on("focusin.setResetTabIndex",_.bind(function(e){this.model.get("insideInteractivity")&&t.next().find("input").focus()},this)),e.on("focusin.setResetTabIndex",_.bind(function(t){this.model.get("insideInteractivity")&&e.prev().find("input").focus()},this))},_attachEventsOnEndElement:function(t,e){e.on("focusin.setResetTabIndex",_.bind(function(e){var i=null,n=null,s=null,a=null,l=0,r=null
if(this.model.get("insideInteractivity")){for(this._setModelValues(t,!1),i=t.find("[tabindex]"),a=i.length;a>l;l++)i.eq(l).attr("tabindex",-1)
n=$(":tabbable:visible:not(:disabled)"),s=$.inArray(this,n),this._setFocusableElementTabIndex(),_.delay(function(){n[s+1]?n[s+1].focus():n[0].focus()},100)}else{for(i=t.find("[tabindex]"),a=i.length;a>l;l++)r=i.eq(l),r.hasClass("disabled")||r.attr("tabindex",r.attr("temp-tabindex"))
this._setModelValues(t,!0),this.model.set("insideInteractivity",!0),this._setFocusableElementTabIndex(),_.delay(_.bind(function(){this.model.get("lastElement").focus()},this),100)}},this))}})
return e})
