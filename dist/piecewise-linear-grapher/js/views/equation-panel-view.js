define(["equation-panel-template","lang-json","constants","equation-popup-view"],function(e,a,t,i){var n=Backbone.View.extend({initialize:function(){this.constants=new t,this.IsPopupVisible=!1,this.accJson=a.accJSON,this.listenTo(this.model.mainModel,"OnLineDatachange",this.OnLineDatachange),this.listenTo(this.model.mainModel,"changeEquationSelection",this.changeEquationSelection),this.listenTo(this.model.mainModel,"OnPopupVisibilityChange",this.OnPopupVisibilityChange),this.checkBoxAccText="",this.editBoxAccText="",this.mainAccText="",this.graphLabelAccText="",this.bRemoveExpressionLine=!1},OnLineDatachange:function(e){this.model.arrayId===e.affectedEqPanelId&&this.renderExpressionArea()},changeEquationSelection:function(e){this.$el.hasClass("plg-equation-panel-"+e.affectedEqPanelId)&&(this.$(".plg-expression-base, .plg-expression-selected").removeClass("plg-expression-selected"),this.$("#"+e.affectedEqPanelId+"-"+e.idSelectedLine).addClass("plg-expression-selected"))},updateEqPanelEditAcc:function(e){this.editBoxAccText=e},OnPopupVisibilityChange:function(e){this.IsPopupVisible=e.bIsVisible,null!==e.affectedExpData&&this.model.arrayId===e.affectedExpData.EqPanelId&&null!==this.model.accManager&&this.model.accManager.isAccessibilityOn&&"Eq Expression Popup"===e.popupName&&(e.affectedExpData.LineId===this.constants.INVALID_VALUE||e.bIsVisible||this.$("#"+this.model.arrayId+"-"+e.affectedExpData.LineId).focus())},render:function(){var e=Handlebars.templates["equation-panel-template"]({number:this.model.number,EqPanelId:this.model.arrayId}).trim()
this.$el.html(e),this.$expArea=this.$("#eq-panel-expression-area"),this.$(".plg-txteditable").attr("maxLength",50),this.renderExpressionArea()},events:{"click .fa-check-square":"checkCheckBoxVisibility","click .fa-times-circle":"removeExpressionLine","click .plg-expression-base":"openSymbolicExpPopup","focusout .plg-txteditable":"onFocusOutChangeTextData","click .plg-txteditable":"OnClicktxtEditable","click .equation-panel-box":"OnEqPanelClick"},renderExpressionArea:function(){var e,a=this.model.mainModel.EqPanelData[this.model.arrayId],t="",i=""
for(e in a.lineData)i=" plg-expression-selected",t+=this.getExpressionHTML(a.lineData[e],e,i)
if(this.$expArea.html(t),this.$("#eq-panel-checkbox-editabletext").addClass(this.model.cssClassName),this.$(".plg-txteditable."+this.model.arrayId).css("background-color",this.$("#eq-panel-checkbox-editabletext").css("background-color")),this.$("#plg-txteditable-"+this.model.arrayId).val(this.model.mainModel.EqPanelData[this.model.arrayId].title).attr("value",this.model.mainModel.EqPanelData[this.model.arrayId].title),this.model.mainModel.EqPanelData[this.model.arrayId].bIsEnable===!0?this.$("#plg-fa-check-square-"+this.model.arrayId).addClass("fa-checked-square"):this.$("#plg-fa-check-square-"+this.model.arrayId).removeClass("fa-checked-square"),null!==this.model.accManager&&this.model.accManager.isAccessibilityOn&&(this.setAccOn(),this.bRemoveExpressionLine)){this.bRemoveExpressionLine=!1
var n=Object.keys(this.model.mainModel.EqPanelData[this.model.arrayId].lineData)
n.length>0?this.$("#"+this.model.arrayId+"-"+n[n.length-1]).focus():this.$el.focus()}},setAccOn:function(){if(null!==this.model.accManager&&this.model.accManager.isAccessibilityOn){var e=this.constants.EQ_BASE_TAB_INDEX+1e3*(this.model.number-1)+this.constants.EQ_BASE_TAB_BUFFER,a=null,t="",i="",n="",s="",l="",o="",d="less than",c="less than"
for(a in this.model.mainModel.EqPanelData[this.model.arrayId].lineData)i=this.model.mainModel.EqPanelData[this.model.arrayId].lineData[a].slope.safe_toFixed(2),n=this.model.mainModel.EqPanelData[this.model.arrayId].lineData[a].displacement.safe_toFixed(1),d="less than",c="less than",s=this.model.mainModel.EqPanelData[this.model.arrayId].lineData[a].x1.safe_toFixed(1),l=this.model.mainModel.EqPanelData[this.model.arrayId].lineData[a].x2.safe_toFixed(1),o=this.model.mainModel.EqPanelData[this.model.arrayId].lineData[a].y1.safe_toFixed(1),this.model.mainModel.EqPanelData[this.model.arrayId].lineData[a].lineTypeId===this.constants.POS_INFINITY_RAY?l="infinity":this.model.mainModel.EqPanelData[this.model.arrayId].lineData[a].lineTypeId===this.constants.NEG_INFINITY_RAY&&(s="minus infinity",o=this.model.mainModel.EqPanelData[this.model.arrayId].lineData[a].y2.safe_toFixed(1)),this.model.mainModel.EqPanelData[this.model.arrayId].lineData[a].xRangeLeftRelation===this.constants.LESS_THAN_OR_EQUAL&&(d="less than or equal to"),this.model.mainModel.EqPanelData[this.model.arrayId].lineData[a].xRangeRightRelation===this.constants.LESS_THAN_OR_EQUAL&&(c="less than or equal to"),t=this.model.mainModel.EqPanelData[this.model.arrayId].lineData[a].idInterceptType!==this.constants.SLOPE_INTERCEPT?"Function "+i+" ( x minus "+s+" ) plus "+o+" for "+s+" "+d+" x "+c+" "+l+" Use spacebar to edit the function.":"Function "+i+" x plus "+n+" for "+s+" "+d+" x "+c+" "+l+" Use spacebar to edit the function.",this.model.accManager.setTabIndex(this.$("#"+this.model.arrayId+"-"+a),e),this.model.accManager.setAccText(this.$("#"+this.model.arrayId+"-"+a),t,null),e+=10,this.model.accManager.setTabIndex(this.$("#remove-"+this.model.arrayId+"-"+a),e),this.model.accManager.setAccText(this.$("#remove-"+this.model.arrayId+"-"+a),"Remove Expression.",null),this.IsPopupVisible&&(this.model.accManager.enableTab(this.$("#"+this.model.arrayId+"-"+a),!1),this.model.accManager.enableTab(this.$("#remove-"+this.model.arrayId+"-"+a),!1)),e+=10
this.setAccOnMain(),this.setAccOnCheck(),this.setAccOnEdit(),this.$(".acc-element").on("keydown",_.bind(this.model.accManager._keyPressHandler,this))}},updateEqPanelAcc:function(e){this.mainAccText=e},updateEqPanelCheckAcc:function(e){this.checkBoxAccText=e},updateEqPanelEditAcc:function(e){this.editBoxAccText=e},setAccOnCheck:function(){var e=(this.model.arrayId,Object.keys(this.model.mainModel.EqPanelData[this.model.arrayId].lineData).length),a="function panel",t="is",i="hidden",n="unhide",s=null,l="unchecked"
0==e?(a="function panel",t="is"):1==e&&(a="function panel",t="is"),this.$("#plg-fa-check-square-"+this.model.arrayId).hasClass("fa-checked-square")&&(l="checked",i="visible",n="hide"),s=[this.model.arrayId,l,a,t,i,n,a],this.model.accManager.setAccText(this.$("#plg-fa-check-square-"+this.model.arrayId),this.checkBoxAccText,s)},setAccOnEdit:function(){var e="Currently the function panel one has no title"
""!==this.model.mainModel.EqPanelData[this.model.arrayId].title&&(e=this.model.mainModel.EqPanelData[this.model.arrayId].title),arrParam=[e],this.model.accManager.setAccText(this.$("#plg-txteditable-"+this.model.arrayId),this.editBoxAccText,arrParam)},setAccOnMain:function(){var e=Object.keys(this.model.mainModel.EqPanelData[this.model.arrayId].lineData).length,a="functions",t=null
0==e?e="no":1==e&&(a="function"),t=[this.model.arrayId,e,a],this.model.accManager.setAccText(this.$el,this.mainAccText,t)},getExpressionHTML:function(e,a,t){e.graphLine.equationPanelData.idSelectedLine!==a&&(t="")
var i="<div id='"+this.model.arrayId+"-"+a+"' class='plg-expression-base"+t+"' title='"+this.equationPanelSymbolicExpression(e)+"'>"
return i+=this.equationPanelSymbolicExpression(e),i+="<span id='remove-"+this.model.arrayId+"-"+a+"' class='plg-expresion-remove-sign fa fa-times-circle fa-lg'></span></div>"},OnClicktxtEditable:function(e){e.stopPropagation()},removeExpressionLine:function(e){e.stopPropagation()
var a=$(e.target),t=a.attr("id").split("-"),i=t[2],n=t[1]
null!==this.model.accManager&&this.model.accManager.isAccessibilityOn&&(this.bRemoveExpressionLine=!0),this.model.mainModel.DeleteLine({EqPanelId:n,LineId:i}),this.model.mainModel.SetEqPanelSelected({EqPanelId:this.model.arrayId})},openSymbolicExpPopup:function(e){e.stopPropagation()
var a=$(e.target),t=this.model,i=t.mainModel,n=a.attr("id").split("-"),s=n[1],l=n[0]
2===n.length&&(i.idSelectedEqPanel!==i.constants.INVALID_VALUE&&i.idSelectedEqPanel!==l&&i.trigger("onDeselectingEquationPanel",{eqPanelId:i.idSelectedEqPanel}),i.idSelectedEqPanel=l,i.trigger("onSelectingEquationPanel",{eqPanelId:i.idSelectedEqPanel}),s!==i.idSelectedLine&&i.EqPanelData[l].lineData[s].graphLine.selectLine(),t.oEqPopup.setAffectedExpData({EqPanelId:l,LineId:s}),i.ChangeLineSelection({EqPanelId:l,LineId:s})),i.SetEqPanelSelected({EqPanelId:this.model.arrayId})},checkCheckBoxVisibility:function(e){$(e.target).toggleClass("fa-checked-square"),this.model.mainModel.ToggleEnableStatus({EqPanelId:this.model.arrayId}),e.stopPropagation(),this.model.mainModel.trigger("lineVisibilityChanged",{affectedEqPanelId:this.model.arrayId}),this.model.mainModel.SetEqPanelSelected({EqPanelId:this.model.arrayId})},equationPanelSymbolicExpression:function(e){var a
return a=e.idInterceptType===this.constants.SLOPE_INTERCEPT?e.expressionSlopeIntercept:e.expressionPointSlope},OnEqPanelClick:function(){this.model.mainModel.SetEqPanelSelected({EqPanelId:this.model.arrayId})},onFocusOutChangeTextData:function(e){e.stopPropagation()
var a=this.$(".plg-txteditable").val()
this.$(".plg-txteditable").attr("value",a),this.model.mainModel.ChangeTextData({EqPanelId:this.model.arrayId,ChangeText:a}),this.setAccOnEdit()}})
return n})
