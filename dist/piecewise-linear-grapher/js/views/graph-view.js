define(["graph-template","lang-json","constants"],function(i,e,t){var n=Backbone.View.extend({initialize:function(i){this.constants=new t,this.accJson=e.accJSON,this.accManager=i.accManager,this.listenTo(this.model,"setSliderToolTip",this.setSliderToolTip),this.listenTo(this.model,"OnPopupVisibilityChange",this.OnPopupVisibilityChange),this.listenTo(this.model,"onExpressionDataChanged",this.onExpressionDataChanged),this.listenTo(this.model,"onLineAdded",this.onLineAdded),this.listenTo(this.model,"lineVisibilityChanged",this.onLineVisibilityChange),this.listenTo(this.model,"OnLineDataDragged",this.updateGraphView),this.listenTo(this.model,"OnSliderDataChange",this.OnSliderDataChange),this.listenTo(this.model,"OnGridOptionsChange",this.renderGraphOnChange),this.listenTo(this.model,"OnAxesLabelChange",this.changeAxesLabel),this.listenTo(this.model,"OnLinePropsChange",this.handleLineProps),this.listenTo(this.model,"onSelectingEquationPanel",this.onSelectingEquationPanel),this.listenTo(this.model,"onDeselectingEquationPanel",this.onDeselectingEquationPanel),this.graphAccText=""},render:function(){Handlebars.templates["graph-template"]({}).trim()
this.gridGraphView=null,this.graphPoints=[],this.linePoints=[],this.graphLine=null,this.shapeType=2,this.fillColor=10197915,this.lineColor=10197915,this.pointRadius=4,this.invisiblePointRadius=0,this.sliderPointRadius=6,this.snapToGrid=!1,this.renderGraphOnChange()},onSelectingEquationPanel:function(i){if(i.eqPanelId!==this.model.constants.INVALID_VALUE&&this.model.EqPanelData[i.eqPanelId].bIsEnable){var e,t,n,a=this.model.EqPanelData[i.eqPanelId].lineData
for(n in a){e=a[n].graphLine.sources
for(t in e)e[t].changeObjectVisibility(!0)}}},onDeselectingEquationPanel:function(i){if(i.eqPanelId!==this.model.constants.INVALID_VALUE&&this.model.EqPanelData[i.eqPanelId].bIsEnable){var e,t,n,a=this.model.EqPanelData[i.eqPanelId].lineData
for(n in a){e=a[n].graphLine.sources
for(t in e)e[t].changeObjectVisibility(!1)}}},setAccOn:function(){null!==this.accManager&&this.accManager.isAccessibilityOn&&this.setAccOnGraph()},onLineAdded:function(i,e){this.renderGraphObjects(i,e)},setSliderToolTip:function(i){this.model.SetSliderPointData({xPos:this.model.sliderValue},i.affectedEqPanelId)},OnSliderDataChange:function(){var i
for(i in this.model.EqPanelData)this.addSliderPointOnReqdLines(i,"line1")},updateGraphAcc:function(i){this.graphAccText=i},setAccOnGraph:function(){var i=this.model.gridOptions.gridLimits,e=i.xUpper,t=i.yUpper,n=i.xLower.safe_toFixed(2),a=i.yLower.safe_toFixed(2),s=[n,e,a,t]
this.accManager.setAccText(this.$el,this.graphAccText,s)},renderGraphOnChange:function(i){this.resetGrid()
var e,t
for(e in this.model.EqPanelData){for(t in this.model.EqPanelData[e].lineData)this.renderGraphObjects(e,t,i)
this.addSliderPointOnReqdLines(e,"line1"),this.model.SetSliderPointData({xPos:this.model.sliderValue},e,!i)}null!==this.accManager&&this.accManager.isAccessibilityOn&&this.setAccOn()},onLineVisibilityChange:function(i){var e,t,n,a=this.model.EqPanelData[i.affectedEqPanelId],s=a.lineData
for(e in s){s[e].graphLine.changeObjectVisibility(a.bIsEnable),t=s[e].graphLine.sources
for(n in t)t[n].changeObjectVisibility(a.bIsEnable)}this.model.SetSliderPointData({xPos:this.model.sliderValue},i.affectedEqPanelId,!0)},onExpressionDataChanged:function(i){var e,t,n,a,s=i.graphLine,h=s.shapeObject.shape.points,r=s.gridGraphView.model,o=s.sources,l=o.length
switch(s.lineType){case 0:for(n=0;l>n;n++)e={},t={},a=s.isPositiveInfinity?n:0===n?1:0,e.x=i["x"+(a+1)],e.y=i["y"+(a+1)],t=r.convertToCanvasCoordinates(e),o[n].shapeObject.shape.x=t.x,o[n].shapeObject.shape.y=t.y,h[2*n]=t.x,h[2*n+1]=t.y,0===n?(s.canvasCoord1.x=t.x,s.canvasCoord1.y=t.y):(s.canvasCoord2.x=t.x,s.canvasCoord2.y=t.y)
s.updateRayInfinity(),s.updateArrowHead()
break
case 1:for(n=0;l>n;n++)e={},t={},e.x=i["x"+(n+1)],e.y=i["y"+(n+1)],t=r.convertToCanvasCoordinates(e),o[n].shapeObject.shape.x=t.x,o[n].shapeObject.shape.y=t.y,h[2*n]=t.x,h[2*n+1]=t.y,0===n?(s.canvasCoord1.x=t.x,s.canvasCoord1.y=t.y):(s.canvasCoord2.x=t.x,s.canvasCoord2.y=t.y)}s._setHitArea(h),this.model.trigger("OnLineDatachange",{affectedEqPanelId:this.model.idSelectedEqPanel}),this.model.trigger("setSliderToolTip",{affectedEqPanelId:this.model.idSelectedEqPanel}),s.gridGraphView._refreshGridGraph()},updateGraphView:function(i){var e=this.model.EqPanelData[this.model.idSelectedEqPanel],t=e.lineData[e.idSelectedLine]
0!==t.graphLine.lineType&&(t.slope=this.model.getSlope(t)),t.displacement=this.model.getIntercept(t),t.expressionSlopeIntercept=this.model.getSlopeInterceptExp(t),t.expressionPointSlope=this.model.getPointSlopeExp(t),this.model.trigger("OnLineDatachange",{affectedEqPanelId:i.affectedEqPanelId}),this.model.trigger("setSliderToolTip",{affectedEqPanelId:i.affectedEqPanelId})},renderGraphObjects:function(i,e,t){var n,a,s=this.model,h=s.EqPanelData[i],r=h.lineData
if(r[e].lineTypeId===this.constants.NEG_INFINITY_RAY?this.drawRay({x:r[e].x2,y:r[e].y2},h.color,1,!1,h,e,t):r[e].lineTypeId===this.constants.POS_INFINITY_RAY?this.drawRay({x:r[e].x1,y:r[e].y1},h.color,1,!0,h,e,t):this.drawLine([{x:r[e].x1,y:r[e].y1},{x:r[e].x2,y:r[e].y2}],h.color,1,h,e),h.bIsEnable&&(this.graphLine.changeObjectVisibility(h.bIsEnable),s.idSelectedEqPanel===i)){n=this.graphLine.sources
for(a in n)n[a].changeObjectVisibility(h.bIsEnable)}t?s.selectedLine&&s.selectedLine.lineId===e&&s.selectedLine.equationPanelData.idEquationPanel===i&&this.graphLine.selectLine():h.bIsEnable&&this.graphLine.selectLine(),this.graphLine.updateSourcePointStyle(r[e])},drawLine:function(i,e,t,n,a){var s,h
for(this.graphLine=this.gridGraphView.addLineToGraph(i[0],i[1],e,t,1),this.graphLine.equationPanelData=n,this.graphLine.lineId=a,this.graphLine.graphView=this,this.graphLine.gridGraphView=this.gridGraphView,n.lineData[this.graphLine.lineId].graphLine=this.graphLine,h=0;h<i.length;h++)s=this.gridGraphView.addPointToGraph(i[h],this.fillColor,this.lineColor,this.pointRadius,null,1),s.gridGraphView=this.gridGraphView,s.graphView=this,this.linePoints.push(i[h]),this.graphLine.sources.push(s),s.offspring=this.graphLine},drawRay:function(i,e,t,n,a,s,h){var r,o,l,d,p=[],g=a.lineData[s]
for(r=n?this.getHighGraphPointFromSlope(g.slope,g.displacement):this.getLowGraphPointFromSlope(g.slope,g.displacement),this.graphLine=this.gridGraphView.addLineToGraph(i,r,e,t,0),this.graphLine.lineId=s,this.graphLine.isPositiveInfinity=n,this.graphLine.equationPanelData=a,this.graphLine.graphView=this,this.graphLine.gridGraphView=this.gridGraphView,a.lineData[s].graphLine=this.graphLine,p.push(i,r),l=p.length,d=0;l>d;d++)o=d===l-1?this.gridGraphView.addPointToGraph(p[d],this.fillColor,this.lineColor,this.invisiblePointRadius,null,2):this.gridGraphView.addPointToGraph(p[d],this.fillColor,this.lineColor,this.pointRadius,null,2),o.gridGraphView=this.gridGraphView,o.graphView=this,this.linePoints.push(p[d]),this.graphLine.sources.push(o),o.offspring=this.graphLine},getHighGraphPoint:function(i){return this.graphPointNew={x:i.x+1,y:i.y+1},gridLimits=this.model.gridOptions.gridLimits,this.graphPointNew.x<gridLimits.xUpper&&this.graphPointNew.y<gridLimits.yUpper&&this.getHighGraphPoint(this.graphPointNew),this.graphPointNew},getHighGraphPointFromSlope:function(i,e){var t=this.model.gridOptions.gridLimits,n=t.xUpper,a=i*n+e
return{x:n,y:a}},getLowGraphPointFromSlope:function(i,e){var t=this.model.gridOptions.gridLimits,n=t.xLower,a=i*n+e
return{x:n,y:a}},getLowGraphPoint:function(i){return this.graphPointNew={x:i.x-1,y:i.y-1},gridLimits=this.model.gridOptions.gridLimits,this.graphPointNew.x>gridLimits.xLower&&this.graphPointNew.y>gridLimits.yLower&&this.getLowGraphPoint(this.graphPointNew),this.graphPointNew},addSliderPointOnLine:function(){this.renderGraphOnChange()},addSliderPointOnReqdLines:function(i,e){var t,n,a=this.model.EqPanelData[i],s=(a.lineData,!1)
n={x:a.xSliderPointPos,y:a.ySliderPointPos},t=this.gridGraphView.addPointToGraph(n,this.fillColor,this.lineColor,this.sliderPointRadius,null,2),a.sliderPoint=t,t.gridGraphView=this.gridGraphView,t.graphView=this,this.gridGraphView.bringToFront(n),a.oCoordLabel=this.gridGraphView.createSliderPointCoords(n),s=!0,s&&a.bIsEnable&&$(".plg-obj-oval-background."+i).show().css("top",t.canvasCoord.y-29+"px"),a.bIsEnable||(a.oCoordLabel.visible=!1,t.changeObjectVisibility(!1))},handleLineProps:function(){},changeAxesLabel:function(){var i,e,t=this.model.textObjAxes
t.textObjXAxis.text=String(this.model.xAxisLabel),t.textObjYAxis.text=String(this.model.yAxisLabel),i=new PIXI.Point(195-t.textObjXAxis.width/2,375),e=new PIXI.Point(0,195+t.textObjYAxis.width/2),t.textObjXAxis.position=i,t.textObjYAxis.position=e,this.gridGraphView._refreshGridGraph()},resetGrid:function(){null==this.gridGraphView?(this.gridGraphView=GridGraphComponent.Views.GridView.createGridGraph(this.model.gridOptions),this.model.textObjAxes=this.gridGraphView.createAxesLabels(this.model.xAxisLabel,this.model.yAxisLabel)):(this.gridGraphView.model=new GridGraphComponent.Models.GridModel(this.model.gridOptions),this.gridGraphView.render(),this.model.textObjAxes=this.gridGraphView.createAxesLabels(this.model.xAxisLabel,this.model.yAxisLabel))}})
return n})
